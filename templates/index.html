<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>County Data Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css"/>
    <style>
        #map { height: 500px; width: 100%; margin-bottom: 20px; }
        body { font-family: Arial, sans-serif; margin: 20px; }
        select, button { margin-right: 10px; margin-bottom: 10px; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; max-height: 200px; }
    </style>
</head>
<body>

<h2>County Data Map</h2>

<label for="dataset">Choose a dataset:</label>
<select id="dataset">
    {% for d in datasets %}
    <option value="{{ d }}">{{ d }}</option>
    {% endfor %}
</select>
<button onclick="previewData()">Preview 10 lines</button>
<button onclick="downloadData()">Download Full Dataset</button>

<div id="map"></div>

<h3>Preview:</h3>
<pre id="preview"></pre>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([27.5, -82.5], 9); // Default center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

let markers = L.layerGroup().addTo(map);

async function fetchGeoJSON(dataset) {
    const res = await fetch(`/get_geojson/${dataset}`);
    if (!res.ok) throw new Error('Failed to fetch dataset');
    return await res.json();
}

async function previewData() {
    const dataset = document.getElementById('dataset').value;
    try {
        const res = await fetch(`/preview/${dataset}`);
        if (!res.ok) throw new Error('Preview fetch failed');
        const data = await res.json();
        document.getElementById('preview').textContent = JSON.stringify(data, null, 2);
        plotPoints(data);
    } catch (err) {
        alert(err);
    }
}

function plotPoints(features) {
    markers.clearLayers();
    features.forEach(f => {
        if (f.geometry && f.geometry.coordinates) {
            const [lng, lat] = f.geometry.coordinates;
            L.marker([lat, lng]).addTo(markers)
                .bindPopup(`${f.properties.number} ${f.properties.street}, ${f.properties.city}`);
        }
    });
}

function downloadData() {
    const dataset = document.getElementById('dataset').value;
    window.location.href = `/download/${dataset}`;
}

// Auto-load first dataset preview
window.onload = previewData;
</script>

</body>
</html>
