<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Residential Data Prototype</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { font-family: Arial; background: url('hurricane_marty_Background.jpg'); background-size: cover; }
  table { border-collapse: collapse; width: 100%; background: rgba(255,255,255,0.9);}
  th, td { border: 1px solid #999; padding: 8px; text-align: left; }
  #map { height: 400px; margin-top: 20px; }
  .download-btn { margin-top: 10px; padding: 10px 20px; background: #ff5722; color: white; border: none; cursor: pointer; }
</style>
</head>
<body>
<h2>Residential Data Prototype</h2>
<div id="table-container"></div>
<button class="download-btn" onclick="downloadCSV()">Download CSV</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
async function loadAddresses() {
    try {
        const res = await fetch("/api/addresses");
        const data = await res.json();
        if(data.error) throw new Error(data.error);

        const features = data.features || [];
        let html = '<table><tr><th>Number</th><th>Street</th><th>Unit</th><th>City</th><th>Latitude</th><th>Longitude</th></tr>';
        features.slice(0, 20).forEach(f => {
            const props = f.properties;
            const coords = f.geometry.coordinates;
            html += `<tr>
                <td>${props.number||''}</td>
                <td>${props.street||''}</td>
                <td>${props.unit||''}</td>
                <td>${props.city||''}</td>
                <td>${coords[1]}</td>
                <td>${coords[0]}</td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById("table-container").innerHTML = html;

        // Map
        const map = L.map('map').setView([25.925, -81.65], 16);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        features.forEach(f => {
            const coords = f.geometry.coordinates;
            L.marker([coords[1], coords[0]]).addTo(map);
        });

    } catch(e) {
        document.getElementById("table-container").innerHTML = `<p style="color:red;">Failed to load data: ${e.message}</p>`;
    }
}

function downloadCSV() {
    window.location.href = "/api/download/addresses";
}

loadAddresses();
</script>
</body>
</html>
